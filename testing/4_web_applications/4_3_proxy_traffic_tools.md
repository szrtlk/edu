## ИНСТРУМЕНТЫ ПРОКСИ ТРАФИКА

### СНИФФИНГ ТРАФИКА
* сниффинг трафика - процесс мониторинга и перехвата всех пакетов (запросов), проходящих через сеть, с помощью инструментов сниффинга
* для работы с протоколом HTTPS необходима установка дополнительных сертификатов

### ИНСТРУМЕНТЫ ПРОКСИ ТРАФИКА
* Fiddler Classic (только для WIndows)
* Fiddler Everywhere
* Charles Proxy
* Mitmproxy (только для MacOS)
* Proxyman (только для MacOS)

### НАСТРОЙКА CHARLES PROXY
* настройка показана на примере MacOS
* установка сертификата в **Charles Proxy** (Help -> SSL Proxying -> Install Charles Root Certificate, далее открывается Keychain Access, далее выбор сертификата, далее вкладка "Доверие", далее выбор "Всегда доверять")
* отключение проксирования компьютера в **Charles Proxy** (Proxy ->  macOS Proxy, снятие галочки; или Proxy -> Proxy Settings, далее вкладка "macOS", далее снимаем галочки "Enable macOS proxy" и "Enable macOS proxy on launch")
* указываем то, что мы будем проксировать в **Charles Proxy** (Proxy -> SSL Proxying Settings, далее вкладка "SSL Proxying", далее ставим галочку "Enable SSL Proxying", далее выбираем в разделе "Inculde" хост (location), если указать *, то будут выбраны все хосты)
* установка сертификата в **браузере**, на примере **Mozilla Firefox** (Настройки, далее раздел "Параметры сети", далее кнопка "Настроить", далее выбор "Ручная настройка Proxy", далее указываем IP-адрес для HTTP прокси и HTTPS прокси и порт 8888)
* IP-адрес можно посмотреть в **Charles Proxy** (Help -> Local IP Addresses)
* после этого в **Charles Proxy** появится уведомление "Connection from...", разрешаем входящее соединение
* после этого в **браузере** заходим на сайт chls.pro/ssl, далее открывается Keychain Access, далее выбор сертификата, далее вкладка "Доверие", далее выбор "Всегда доверять"

### РАБОТА С CHARLES PROXY
* открываем в **браузере** веб-приложение
* после этого в **Charles Proxy** отображаются запросы веб-приложения
* список запросов можно очистить (кнопка со знаком метлы), после чего обновить вкладку или запустить новое веб-приложение
* можно выбрать структуру отображения в **Charles Proxy** (Structure или Sequence)
* для поиска и выбора необходимого запроса можно использовать поле "Filter"
* вкладка "Overview" содержит параметры запроса (URL, статус, код запроса, протокол, метод запроса, данные сервера (хост, IP, порт), данные клиента (IP, порт), формат общения клиента и сервера и прочее)
* вкладка "Request" содержит заголовки запроса
* вкладка "Response" содержит ответ в выбранном формате (можно выбрать JSON, JSON Text или другой формат, также можно посмотреть заголовки ответа (Headers))

### СПОСОБЫ ПОДМЕНЫ ДАННЫХ
* breakpont *(в случае необходимости быстрой подмены)*
* rewite *(в случае, если задан тайм-аут на ответ от сервера)*
* map local *(в случае, если сервер не готов)*

### BREAKPOINT
* во время выполнения запроса или получения ответа запрос/ответ будет перехватываться, и его можно будет изменить в **режиме реального времени**
* так как на клиентах иногда добавляют таум-аут (если клиент не дождался ответа от сервера, будет выполнен повторный запрос), то не всегда этот способ удобен
* можно использовать во время тестирования API или разных ответов сервера
* копируем URL из поля "URL" на вкладке "Overview"
* Proxy -> Breakpoint Settings
* ставим галочку "Enable Breakpoints"
* добавляем URL в поле "Host", после чего он разобьётся на поля "Host", "Path", "Query"
* параметры в поле "Query", уникальные для текущего запроса, нужно удалить; если их оставить, то при выполнении нового запроса он не перехватится
* ставим галочку "Request" и/или "Response" в зависимости, где находятся тестовые данные
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)
* переходим в **Charles Proxy** на вкладку "Edit Response" (если ранее была выбрана галочка "Response")
* выбираем формат JSON Text
* изменяем значения необходимых параметров
* нажимаем кнопку "Execute"
* смотрим изменение параметров в веб-приложении в **браузере**
* изменения отображаются только на клиенте, на сервере изменений нет

### REWRITE
* создаёт правило, которые изменяют запросы и ответы, проходящие через **Charles Proxy**
* копируем URL из поля "URL" на вкладке "Overview"
* Tools -> Rewrite
* ставим галочку "Enable Rewrite"
* добавляем правило, нажимаем кнопку "Add"
* добавляем имя правила
* нажимаем кнопку "Add" в разделе "Location"
* добавляем URL в поле "Host", после чего он разобьётся на поля "Host", "Path", "Query"
* параметры в поле "Query", уникальные для текущего запроса, нужно удалить; если их оставить, то при выполнении нового запроса он не перехватится
* копируем необходимый параметр для замены на вкладке "Response"
* нажимаем кнопку "Add" в разделе "Type"
* выбираем Type, например, Body
* ставим галочку "Request" и/или "Response" в зависимости, где находятся тестовые данные
* заполняем значение (Value) параметра до и после замены (Match и Replace), вставляем имя и значение параметра, но между ними **удаляем пробел**, запятая в конце сохраняется,
* для замены каждого параметра создаём отдельное правило
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)
* смотрим изменение параметров в веб-приложении в **браузере**
* изменения отображаются только на клиенте, на сервере изменений нет

### MAP LOCAL
* создаёт локальные файлы, словно они являются частью сервера
* заранее подготовливаем ответ, который будет подменён во время выполнения запроса на сервер и ответа сервера
* map local позволяет "замокать" ответ, может использоваться в случае, если не готов back-end
* копируем URL из поля "URL" на вкладке "Overview"
* Tools -> Map Local
* нажимаем галочку "Enable Map Local"
* добавляем URL в поле "Host", после чего он разобьётся на поля "Host", "Path", "Query"
* параметры в поле "Query", уникальные для текущего запроса, нужно удалить; если их оставить, то при выполнении нового запроса он не перехватится
* в разделе "Map To" заполняем поле "Local Path", добавляем адрес файла, который содержит ответ на предполагаемый запрос
* можно скопировать информацию со вкладки "Response", заменить значения необходимых параметров и сохранить файл в формате JSON
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)
* смотрим изменение параметров в веб-приложении в **браузере**

### THROTTLING
* позволяет управлять скоростью загрузки
* Proxy -> Throttle Settings
* можно включить троттлинг
* можно задать троттлинг либо для определённого хоста, либо для всех запросов
* можно задать либо одно из возможных значений (Throttle preset) либо настроить параметры самостоятельно
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)

### REVERSE PROXIES
* позволяет принимать запросы из Internet и перенаправлять их на один из веб-серверов
* Proxy -> Reverse Proxies
* можно, например, перенаправить информацию с одного порта на другой (для этого нужно задать значение обоих портов)
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)

### NO CACHING
* предотвращает кэширование, манипулируя заголовками HTTP, которые управляют кэшированием ответов
* Tools -> No Caching
* можно отключить кэширование
* можно отключить кэширование либо для определённого хоста, либо для всех запросов
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)

### MAP REMOTE
* позволяет переадресовывать запросы с одного URL на другой
* Tools -> Map Remote
* можно указать текущий URL и URL, на который его нужно заменить (Map From, Map To)
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)

### BLOCK LIST
* позволяет блокировать определённые доменные имена
* Tools -> Black List
* можно выбрать необходимое блокирующее действие (Drop connection или Return 403 response) и добавить необходимый хост, в поле "Path" можно поставить *, если необходимо указать все пути
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)
* в случае выбора "Return 403 response" можно увидеть, что при выполнении запроса в ответе возвращается ошибка 403

### DNS SPOOFING
* позволяет проверить обращение к конкрентому серверу (если их несколько)
* Tools -> DNS Spoofing
* можно задать хост (Host Name) и IP-адрес (Address)
* запросы с выбранного хоста будут отправляться на выбранный IP-адрес
* если в начале и конце адреса хоста указать *, то правило будет выполняться для всех запросов, которые содержат данный адрес хоста
* далее обновляем веб-приложение в **браузере** (можно перед обновлением очистить список запросов в **Charles Proxy**)
* на вкладке "Response" можно увидеть изменение в строке "Remote Address"

### MIRROR
* позволяет автоматически сохранять все ответы, возвращаемые в Charles Proxy
* Tools -> Mirror
* в случае падения сервера или тестовой среды сохранённые данные можно использовать для Map Local

### КОНТЕКСТНОЕ МЕНЮ ЗАПРОСОВ
* Сompose позволяет редактировать запросы из списка?, после редактирования запроса нужно нажать кнопку "Execute" для отправки его на сервер
* Focus позволяет переместить домен на первые позиции в списке
* Repeat позволяет отправить на сервер запрос, аналогичный выбранному
* Repeat Advanced позволяет отправить на сервер запрос, аналогичный выбранному, а также задать количество запросов (Concurrency) и задержку между ними (Iterations), функция может быть полезна при проверке реакции сервера на флуд
